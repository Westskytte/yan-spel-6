<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yan – Tärningsspel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 2rem; }
    table input {
      width: 6ch;
      padding: 0.25rem;
      box-sizing: border-box;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    .readonly { background: #eee; }
    .dice-container { margin-bottom: 1rem; }
    .die {
      display: inline-block; width: 40px; height: 40px;
      line-height: 40px; text-align: center;
      font-size: 20px; border: 2px solid #333;
      border-radius: 6px; margin-right: 6px; cursor: pointer;
    }
    .selected { background-color: #d1e7dd; border-color: #0f5132; }
    .player-section { margin-bottom: 2rem; padding: 1rem; border: 2px solid transparent; }
    .active-player { border-color: #0d6efd; background-color: #f0f8ff; }
    .highlighted { background-color: #d4edda !important; }
    .log { font-size: 0.9em; margin-top: 0.5rem; }
    .column-label { width: 60px; text-align: center; }
    .row-label { width: 8ch; text-align: center; }
    .suggestion-entry { margin-bottom: 0.5rem; padding: 0.25rem; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
    .suggestion-entry:hover {
      background: #f8f9fa;
      cursor: pointer;
    }
    .hover-target {
      outline: 2px dashed #6c757d;
      outline-offset: -2px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Yan – Tärningsspel</h1>
  <div class="mb-3">
    <label for="numPlayers" class="form-label">Antal spelare:</label>
    <input type="number" id="numPlayers" class="form-control" min="1" max="6" value="2">
    <button class="btn btn-primary mt-2" onclick="setupGame()">Starta spel</button>
  </div>
  <h3 id="activePlayerLabel" class="text-primary"></h3>
  <div id="gameArea"></div>
</div>
<script>
let currentPlayer = 0;
let playerData = [];
let maxRolls = 3;

function setupGame() {
  const numPlayers = parseInt(document.getElementById('numPlayers').value);
  const gameArea = document.getElementById('gameArea');
  gameArea.innerHTML = '';
  playerData = [];

  for (let p = 0; p < numPlayers; p++) {
    const player = {
      name: `Spelare ${p + 1}`,
      rolls: 0,
      dice: [0, 0, 0, 0, 0],
      held: [false, false, false, false, false],
      scores: {},
      section: null,
    };
    playerData.push(player);

    const section = document.createElement('div');
    section.className = 'player-section';
    if (p === 0) section.classList.add('active-player');
    player.section = section;

    const nameLabel = document.createElement('h4');
    nameLabel.textContent = player.name;
    section.appendChild(nameLabel);

    const diceContainer = document.createElement('div');
    diceContainer.className = 'dice-container';
    for (let i = 0; i < 5; i++) {
      const die = document.createElement('div');
      die.className = 'die';
      die.textContent = '-';
      die.onclick = () => toggleHold(p, i);
      diceContainer.appendChild(die);
    }
    section.appendChild(diceContainer);

    const rollButton = document.createElement('button');
    rollButton.className = 'btn btn-secondary me-2';
    rollButton.textContent = 'Slå tärning';
    rollButton.onclick = () => rollDice(p);
    section.appendChild(rollButton);

    const nextButton = document.createElement('button');
    nextButton.className = 'btn btn-outline-primary';
    nextButton.textContent = 'Nästa spelare';
    nextButton.onclick = () => changePlayer();
    section.appendChild(nextButton);

    const suggestionBox = document.createElement('div');
    suggestionBox.className = 'my-2';
    suggestionBox.id = `suggestions-${p}`;
    section.appendChild(suggestionBox);

    const table = document.createElement('table');
    table.className = 'table table-bordered text-center';
    const thead = document.createElement('thead');
    const headRow = document.createElement('tr');
    ['Ruta', '↓', 'L', '↑', '1'].forEach(label => {
      const th = document.createElement('th');
      th.textContent = label;
      headRow.appendChild(th);
    });
    thead.appendChild(headRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    const rowLabels = [
      '1:or', '2:or', '3:or', '4:or', '5:or', '6:or',
      'SUMMA', 'BONUS', 'MIN', 'MAX',
      '2 PAR', 'FULL', 'STEGE', 'FYRTAL', 'YAN'
    ];
    rowLabels.forEach(rowLabel => {
      const row = document.createElement('tr');
      const tdLabel = document.createElement('td');
      tdLabel.textContent = rowLabel;
      row.appendChild(tdLabel);
      for (let i = 0; i < 4; i++) {
        const cell = document.createElement('td');
        const input = document.createElement('input');
        input.type = 'text';
        input.disabled = rowLabel === 'SUMMA' || rowLabel === 'BONUS';
        input.dataset.row = rowLabel;
        input.dataset.col = i + 1;
        input.dataset.player = p;
        input.onchange = () => lockInput(input);
        cell.appendChild(input);
        row.appendChild(cell);
      }
      tbody.appendChild(row);
    });
    table.appendChild(tbody);
    section.appendChild(table);
    gameArea.appendChild(section);
  }
  updateActivePlayerLabel();
}

function updateActivePlayerLabel() {
  document.querySelectorAll('.player-section').forEach((sec, idx) => {
    sec.classList.toggle('active-player', idx === currentPlayer);
  });
  document.getElementById('activePlayerLabel').innerText = `Tur: ${playerData[currentPlayer].name}`;
}

function toggleHold(playerIndex, dieIndex) {
  const player = playerData[playerIndex];
  if (player.rolls === 0) return;
  player.held[dieIndex] = !player.held[dieIndex];
  renderDice(playerIndex);
}

function rollDice(playerIndex) {
  const player = playerData[playerIndex];
  if (player.rolls >= maxRolls) return;
  for (let i = 0; i < 5; i++) {
    if (!player.held[i]) {
      player.dice[i] = Math.floor(Math.random() * 6) + 1;
    }
  }
  player.rolls++;
  renderDice(playerIndex);
  showSuggestions(playerIndex);
}

function renderDice(playerIndex) {
  const player = playerData[playerIndex];
  const diceContainer = player.section.querySelector('.dice-container');
  [...diceContainer.children].forEach((die, i) => {
    die.textContent = player.dice[i] || '-';
    die.classList.toggle('selected', player.held[i]);
  });
}

function changePlayer() {
  const player = playerData[currentPlayer];
  if (!Object.values(player.scores).some(v => v != null)) {
    alert('Du måste fylla i en ruta innan du byter spelare!');
    return;
  }
  player.rolls = 0;
  player.dice = [0, 0, 0, 0, 0];
  player.held = [false, false, false, false, false];
  currentPlayer = (currentPlayer + 1) % playerData.length;
  updateActivePlayerLabel();
}

function lockInput(input) {
  input.readOnly = true;
  if (input.value === '0') input.value = 'X';
  const player = playerData[+input.dataset.player];
  player.scores[`${input.dataset.row}-${input.dataset.col}`] = input.value;
}

function showSuggestions(playerIndex) {
  const suggestions = document.getElementById(`suggestions-${playerIndex}`);
  const dice = playerData[playerIndex].dice;
  const counts = Array(6).fill(0);
  dice.forEach(val => counts[val - 1]++);
  const results = [];

  for (let i = 0; i < 6; i++) {
    if (counts[i] > 0) results.push({ label: `${i + 1}: ${counts[i]}x = ${(i + 1) * counts[i]}p`, action: () => fillCell(`${i + 1}:or`) });
  }

  if (counts.filter(c => c === 2).length >= 2) {
    const score = dice.reduce((a, b) => a + b, 0) + 10;
    results.push({ label: `2 PAR = ${score}p`, action: () => fillCell('2 PAR') });
  }

  if (counts.includes(3) && counts.includes(2)) {
    const score = dice.reduce((a, b) => a + b, 0) + 20;
    results.push({ label: `FULL = ${score}p`, action: () => fillCell('FULL') });
  }

  if ([0,1,2,3,4].every(i => counts[i] >= 1)) {
    results.push({ label: `STEGE 1–5 = 45p`, action: () => fillCell('STEGE', 45) });
  }
  if ([1,2,3,4,5].every(i => counts[i] >= 1)) {
    results.push({ label: `STEGE 2–6 = 50p`, action: () => fillCell('STEGE', 50) });
  }

  if (counts.includes(4)) {
    const score = dice.reduce((a, b) => a + b, 0) + 40;
    results.push({ label: `FYRTAL = ${score}p`, action: () => fillCell('FYRTAL') });
  }

  if (counts.includes(5)) {
    const num = counts.indexOf(5) + 1;
    const base = num * 5;
    const bonus = num === 5 ? 70 : num === 6 ? 80 : 50;
    const score = base + bonus;
    results.push({ label: `YAN = ${score}p`, action: () => fillCell('YAN') });
  }

  suggestions.innerHTML = '';
  results.forEach(r => {
    const div = document.createElement('div');
    div.className = 'suggestion-entry';
    const span = document.createElement('span');
    span.textContent = r.label;
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm btn-success';
    btn.textContent = 'Fyll i';
    btn.onclick = r.action;
    div.appendChild(span);
    div.appendChild(btn);
    suggestions.appendChild(div);
  });
}

function fillCell(label, fixedValue = null) {
  const table = playerData[currentPlayer].section.querySelector('table');
  const inputs = table.querySelectorAll(`input[data-row="${label}"]`);
  for (let input of inputs) {
    if (!input.value) {
      input.value = fixedValue ?? calculateScore(label);
      lockInput(input);
      showSuggestions(currentPlayer);
      return;
    }
  }
}

function calculateScore(label) {
  const dice = playerData[currentPlayer].dice;
  if (label.match(/^\d:or$/)) {
    const num = parseInt(label);
    return dice.filter(d => d === num).reduce((a, b) => a + b, 0);
  }
  return dice.reduce((a, b) => a + b, 0); // fallback total
}
</script>
</body>
</html>
