<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yan ‚Äì Webapp med Turordning</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 2rem; }
    table input {
      width: 6ch;
      padding: 0.25rem;
      box-sizing: border-box;
      text-align: center;
      transition: background-color 0.3s ease;
    }
    .readonly { background: #eee; }
    .dice-container { margin-bottom: 1rem; }
    .die {
      display: inline-block; width: 40px; height: 40px;
      line-height: 40px; text-align: center;
      font-size: 20px; border: 2px solid #333;
      border-radius: 6px; margin-right: 6px; cursor: pointer;
    }
    .selected { background-color: #d1e7dd; border-color: #0f5132; }
    .player-section { margin-bottom: 2rem; padding: 1rem; border: 2px solid transparent; }
    .active-player { border-color: #0d6efd; background-color: #f0f8ff; }
    .highlighted { background-color: #d4edda !important; }
    .log { font-size: 0.9em; margin-top: 0.5rem; }
    .column-label { width: 60px; text-align: center; }
    .row-label { width: 8ch; text-align: center; }
    .suggestion-entry { margin-bottom: 0.5rem; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Yan ‚Äì T√§rningsspel</h1>
  <div class="mb-3">
    <label for="numPlayers" class="form-label">Antal spelare:</label>
    <input type="number" id="numPlayers" class="form-control" min="1" max="6" value="2">
    <button class="btn btn-primary mt-2" onclick="setupGame()">Starta spel</button>
  </div>
  <h3 id="activePlayerLabel" class="text-primary"></h3>
  <div id="gameArea"></div>
</div>
<script>
function applySuggestion(p, suggestion) {
  for (let c of [4,3,1,2]) {
    const data = playerData[p];
    if (c === 4 && data.rollCount > 1) continue; // kolumn 4 endast vid f√∂rsta slaget
    const cell = document.getElementById(`p${p}_c${c}_${suggestion.row}`);
    if (cell && !cell.value) {
      cell.value = suggestion.value;
      calculateSums(p);
      return;
    }
  }
}
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const observer = new MutationObserver(() => {
    playerData.forEach((player, p) => {
      if (player && player.rollCount > 1) {
        rows.forEach(row => {
          const cell = document.getElementById(`p${p}_c4_${row.key}`);
          if (cell && !cell.readOnly) {
            cell.readOnly = true;
            cell.classList.add("readonly");
          }
        });
      }
    });
  });
  observer.observe(document.getElementById("gameArea"), { childList: true, subtree: true });
  // üî¥ L√§gg till visuell varning + kryss vid 0
  const updateRestrictions = () => {
    playerData.forEach((player, p) => {
      if (!player) return;
      rows.forEach(row => {
        const cell = document.getElementById(`p${p}_c4_${row.key}`);
        if (cell) {
          // Blockera manuell inmatning efter f√∂rsta slaget
          if (player.rollCount > 1 && !cell.readOnly) {
            cell.readOnly = true;
            cell.classList.add("readonly");
            cell.title = "Du kan endast fylla i kolumn 1 efter f√∂rsta slaget.";
          }

          // Visuell varning vid f√∂rs√∂k att skriva
          cell.addEventListener("focus", () => {
            if (player.rollCount > 1) {
              cell.blur();
              cell.style.border = "2px solid red";
              setTimeout(() => cell.style.border = "", 1000);
            }
          });

          // Visa kryss om v√§rde = 0
          cell.addEventListener("input", () => {
            if (cell.value === "0") {
              cell.value = "‚úñ";
              cell.readOnly = true;
              cell.classList.add("readonly");
            }
          });
        }
      });
    });
  };

  observer.observe(document.getElementById("gameArea"), { childList: true, subtree: true });
  updateRestrictions();

  // üîí L√§gg till turordningssp√§rr f√∂r kolumn 1 (‚Üì) och kolumn 3 (‚Üë)
  playerData.forEach((player, p) => {
    if (!player) return;
    const col1Order = ['r1','r2','r3','r4','r5','r6','sum16','bonus','min','max','pair2','full','straight','four','yan'];
    const col3Order = [...col1Order].reverse();

    // Kolumn 1 (‚Üì)
    for (let i = 1; i < col1Order.length; i++) {
      const prev = document.getElementById(`p${p}_c1_${col1Order[i - 1]}`);
      const current = document.getElementById(`p${p}_c1_${col1Order[i]}`);
      if (current && prev && !prev.value) {
        current.readOnly = true;
        current.classList.add("readonly");
        current.title = "F√∂reg√•ende ruta m√•ste fyllas i f√∂rst (kolumn ‚Üì).";
      }
    }

    // Kolumn 3 (‚Üë)
    for (let i = 1; i < col3Order.length; i++) {
      const prev = document.getElementById(`p${p}_c3_${col3Order[i - 1]}`);
      const current = document.getElementById(`p${p}_c3_${col3Order[i]}`);
      if (current && prev && !prev.value) {
        current.readOnly = true;
        current.classList.add("readonly");
        current.title = "F√∂reg√•ende ruta m√•ste fyllas i f√∂rst (kolumn ‚Üë).";
      }
    }
  });
});
</script>
<script>
let currentPlayerTurn = 0;
const maxRolls = 3;
const playerData = [];

const rows = [
  {key:'r1', label:'1:or'}, {key:'r2', label:'2:or'}, {key:'r3', label:'3:or'},
  {key:'r4', label:'4:or'}, {key:'r5', label:'5:or'}, {key:'r6', label:'6:or'},
  {key:'sum16', label:'Summa', readonly:true}, {key:'bonus', label:'Bonus', readonly:true},
  {key:'min', label:'MIN'}, {key:'max', label:'MAX'},
  {key:'pair2', label:'2 PAR'}, {key:'full', label:'FULL'},
  {key:'straight', label:'STEGE'}, {key:'four', label:'FYRTAL'}, {key:'yan', label:'YAN'},
  {key:'sumcol', label:'Sum kol.', readonly:true}, {key:'total', label:'Total', readonly:true}
];

function setupGame() {
  const num = parseInt(document.getElementById('numPlayers').value);
  const gameArea = document.getElementById('gameArea');
  gameArea.innerHTML = '';
  playerData.length = 0;

  for (let p = 0; p < num; p++) {
    const section = document.createElement('div');
    section.className = 'player-section';
    section.id = `playerSection${p}`;
    section.innerHTML = `
      <h4>Spelare ${p + 1}: <input type="text" id="playerName${p}" placeholder="Namn" /></h4>
      <div class="dice-container" id="diceContainer${p}"></div>
      <div id="suggestions${p}" class="mb-2"></div>
      <button class="btn btn-secondary mb-2" onclick="rollDice(${p})" id="rollBtn${p}">Sl√• t√§rning</button>
      <button class="btn btn-outline-dark mb-2" onclick="nextPlayer()" id="nextBtn${p}" disabled>N√§sta spelare</button>
      <p>Slag kvar: <span id="rollsLeft${p}">3</span></p>
      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead>
            <tr>
              <th class="row-label">Ruta</th>
              <th class="column-label">‚Üì</th>
              <th class="column-label">L</th>
              <th class="column-label">‚Üë</th>
              <th class="column-label">1</th>
            </tr>
          </thead>
          <tbody id="yanBody${p}"></tbody>
        </table>
      </div>
      <div class="log" id="log${p}"><strong>Historik:</strong><ul></ul></div>
    `;
    gameArea.appendChild(section);

    const tableBody = document.getElementById(`yanBody${p}`);
    rows.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.label}</td>`;
      for (let c = 1; c <= 4; c++) {
        const id = `p${p}_c${c}_${row.key}`;
        const input = document.createElement('input');
        input.type = 'text';
        input.id = id;
        input.className = row.readonly ? 'readonly form-control' : 'form-control';
        input.readOnly = !!row.readonly;
        input.oninput = () => calculateSums(p);
        const td = document.createElement('td');
        td.appendChild(input);
        tr.appendChild(td);
      }
      tableBody.appendChild(tr);
    });

    playerData.push({
      rollCount: 0,
      dice: [0, 0, 0, 0, 0],
      selected: [false, false, false, false, false]
    });
  }
  updatePlayerTurn();
}

function rollDice(p) {
  if (p !== currentPlayerTurn) return;
  const data = playerData[p];
  if (data.rollCount >= maxRolls) return;
  for (let i = 0; i < 5; i++) {
    if (!data.selected[i]) {
      data.dice[i] = Math.floor(Math.random() * 6) + 1;
    }
  }
  data.rollCount++;
  document.getElementById(`rollsLeft${p}`).innerText = maxRolls - data.rollCount;
  updateDiceDisplay(p);
}

function updateDiceDisplay(p) {
  const container = document.getElementById(`diceContainer${p}`);
  const data = playerData[p];
  container.innerHTML = '';
  data.dice.forEach((val, i) => {
    const die = document.createElement('div');
    die.className = 'die' + (data.selected[i] ? ' selected' : '');
    die.innerText = val || '-';
    die.onclick = () => {
      data.selected[i] = !data.selected[i];
      updateDiceDisplay(p);
    };
    container.appendChild(die);
  });

  // Visa m√∂jliga kombinationer (mockup, b√∂r ut√∂kas)
  const suggestions = document.getElementById(`suggestions${p}`);
  suggestions.innerHTML = '';
  const dice = data.dice.filter(Boolean);
  if (dice.length === 5) {
    const counts = {};
    dice.forEach(d => counts[d] = (counts[d] || 0) + 1);
    const unique = Object.keys(counts).map(Number);
    const values = Object.values(counts);
    const total = dice.reduce((a, b) => a + b, 0);

    // FULL
    if (values.includes(3) && values.includes(2)) {
      const div = document.createElement('div');
      div.className = 'suggestion-entry';
      div.innerHTML = `FULL (${total + 20}p) <button onclick="applySuggestion(${p}, {row: 'full', value: ${total + 20}})">Anv√§nd</button>`;
      suggestions.appendChild(div);
    }
    // 2 PAR
    if (values.filter(v => v >= 2).length >= 2) {
      const div = document.createElement('div');
      div.className = 'suggestion-entry';
      div.innerHTML = `2 PAR (${total + 10}p) <button onclick="applySuggestion(${p}, {row: 'pair2', value: ${total + 10}})">Anv√§nd</button>`;
      suggestions.appendChild(div);
    }
    // FYRTAL
    if (values.includes(4)) {
      const div = document.createElement('div');
      div.className = 'suggestion-entry';
      div.innerHTML = `FYRTAL (${total + 40}p) <button onclick="applySuggestion(${p}, {row: 'four', value: ${total + 40}})">Anv√§nd</button>`;
      suggestions.appendChild(div);
    }
    // YAN
    if (values.includes(5)) {
      const face = parseInt(Object.keys(counts).find(k => counts[k] === 5));
      let bonus = face === 6 ? 80 : face === 5 ? 70 : 50;
      const div = document.createElement('div');
      div.className = 'suggestion-entry';
      div.innerHTML = `YAN (${total + bonus}p) <button onclick="applySuggestion(${p}, {row: 'yan', value: ${total + bonus}})">Anv√§nd</button>`;
      suggestions.appendChild(div);
    }
    // STEGE
    const smallStraight = [1,2,3,4,5].every(n => dice.includes(n));
    const largeStraight = [2,3,4,5,6].every(n => dice.includes(n));
    if (smallStraight || largeStraight) {
      const div = document.createElement('div');
      const base = smallStraight ? 15 : 20;
      div.className = 'suggestion-entry';
      div.innerHTML = `STEGE (${base + 30}p) <button onclick="applySuggestion(${p}, {row: 'straight', value: ${base + 30}})">Anv√§nd</button>`;
      suggestions.appendChild(div);
    }
    // MIN/MAX
    const minDiv = document.createElement('div');
    minDiv.className = 'suggestion-entry';
    minDiv.innerHTML = `MIN (${total}p) <button onclick="applySuggestion(${p}, {row: 'min', value: ${total}})">Anv√§nd</button>`;
    suggestions.appendChild(minDiv);

    const maxDiv = document.createElement('div');
    maxDiv.className = 'suggestion-entry';
    maxDiv.innerHTML = `MAX (${total}p) <button onclick="applySuggestion(${p}, {row: 'max', value: ${total}})">Anv√§nd</button>`;
    suggestions.appendChild(maxDiv);
  }
    }
  }
  });
}

function nextPlayer() {
  const p = currentPlayerTurn;
  let hasFilled = false;
  for (let r = 0; r < rows.length; r++) {
    const row = rows[r];
    for (let c = 1; c <= 4; c++) {
      const cell = document.getElementById(`p${p}_c${c}_${row.key}`);
      if (cell && cell.value && !isNaN(cell.value)) {
        hasFilled = true;
        break;
      }
    }
    if (hasFilled) break;
  }
  if (!hasFilled) {
    alert("Du m√•ste fylla i ett v√§rde i spelplanen innan du g√•r vidare.");
    return;
  }

  playerData[p].rollCount = 0;
  playerData[p].dice = [0, 0, 0, 0, 0];
  playerData[p].selected = [false, false, false, false, false];
  updateDiceDisplay(p);
  currentPlayerTurn = (currentPlayerTurn + 1) % playerData.length;
  updatePlayerTurn();
}

function updatePlayerTurn() {
  document.querySelectorAll('.player-section').forEach((el, i) => {
    el.classList.toggle('active-player', i === currentPlayerTurn);
    document.getElementById(`rollBtn${i}`).disabled = i !== currentPlayerTurn;
    document.getElementById(`nextBtn${i}`).disabled = i !== currentPlayerTurn;
  });
  const nameInput = document.getElementById(`playerName${currentPlayerTurn}`);
  const name = nameInput && nameInput.value ? nameInput.value : `Spelare ${currentPlayerTurn + 1}`;
  document.getElementById('activePlayerLabel').innerText = `Tur: ${name}`;
}

function calculateSums(p) {
  for (let c = 1; c <= 4; c++) {
    let upperSum = 0;
    let totalSum = 0;
    for (let i = 1; i <= 6; i++) {
      const cell = document.getElementById(`p${p}_c${c}_r${i}`);
      const val = parseInt(cell?.value);
      if (!isNaN(val)) upperSum += val;
    }
    const sum16 = document.getElementById(`p${p}_c${c}_sum16`);
    const bonus = document.getElementById(`p${p}_c${c}_bonus`);
    if (sum16) sum16.value = upperSum;
    const bonusVal = upperSum >= 70 ? 70 : upperSum >= 60 ? 60 : 0;
    if (bonus) bonus.value = bonusVal;
    totalSum = upperSum + bonusVal;
    ['min','max','pair2','full','straight','four','yan'].forEach(key => {
      const cell = document.getElementById(`p${p}_c${c}_${key}`);
      const val = parseInt(cell?.value);
      if (!isNaN(val)) totalSum += val;
    });
    const sumcol = document.getElementById(`p${p}_c${c}_sumcol`);
    const total = document.getElementById(`p${p}_c${c}_total`);
    if (sumcol) sumcol.value = totalSum;
    const multiplier = c === 1 ? 2 : c === 2 ? 1 : c === 3 ? 3 : 4;
    if (total) total.value = totalSum * multiplier;
  }
}
</script>
</body>
</html>
