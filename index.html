<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yan ‚Äì Webapp med Turordning</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { padding: 2rem; }
    table input { width: 4ch; padding: 0.25rem; box-sizing: border-box; text-align: center; }
    .readonly { background: #eee; }
    .dice-container { margin-bottom: 1rem; }
    .die {
      display: inline-block; width: 40px; height: 40px;
      line-height: 40px; text-align: center;
      font-size: 20px; border: 2px solid #333;
      border-radius: 6px; margin-right: 6px; cursor: pointer;
    }
    .selected { background-color: #d1e7dd; border-color: #0f5132; }
    .player-section { margin-bottom: 2rem; padding: 1rem; border: 2px solid transparent; }
    .active-player { border-color: #0d6efd; background-color: #f0f8ff; }
    .highlighted { background-color: #d4edda !important; }
    .log { font-size: 0.9em; margin-top: 0.5rem; }
    .column-label { width: 60px; }
    .row-label { width: 120px; }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">Yan ‚Äì T√§rningsspel</h1>
  <div class="mb-3">
    <label for="numPlayers" class="form-label">Antal spelare:</label>
    <input type="number" id="numPlayers" class="form-control" min="1" max="6" value="2">
    <button class="btn btn-primary mt-2" onclick="setupGame()">Starta spel</button>
  </div>
  <h3 id="activePlayerLabel" class="text-primary"></h3>
  <div id="gameArea"></div>
</div>
<script>
let currentPlayerTurn = 0;
const maxRolls = 3;
const playerData = [];

const rows = [
  {key:'r1', label:'1:or'}, {key:'r2', label:'2:or'}, {key:'r3', label:'3:or'},
  {key:'r4', label:'4:or'}, {key:'r5', label:'5:or'}, {key:'r6', label:'6:or'},
  {key:'sum16', label:'Summa', readonly:true}, {key:'bonus', label:'Bonus', readonly:true},
  {key:'min', label:'MIN'}, {key:'max', label:'MAX'},
  {key:'pair2', label:'2 PAR'}, {key:'full', label:'FULL'},
  {key:'straight', label:'STEGE'}, {key:'four', label:'FYRTAL'}, {key:'yan', label:'YAN'},
  {key:'sumcol', label:'Sum kol.', readonly:true}, {key:'total', label:'Total', readonly:true}
];

function setupGame() {
  const num = parseInt(document.getElementById('numPlayers').value);
  const gameArea = document.getElementById('gameArea');
  gameArea.innerHTML = '';
  playerData.length = 0;

  for (let p = 0; p < num; p++) {
    const section = document.createElement('div');
    section.className = 'player-section';
    section.id = `playerSection${p}`;
    section.innerHTML = `
      <h4>Spelare ${p + 1}: <input type="text" id="playerName${p}" placeholder="Namn" /></h4>
      <div class="dice-container" id="diceContainer${p}"></div>
      <div id="suggestions${p}" class="mb-2"></div>
      <button class="btn btn-secondary mb-2" onclick="rollDice(${p})" id="rollBtn${p}">Sl√• t√§rning</button>
      <button class="btn btn-outline-dark mb-2" onclick="nextPlayer()" id="nextBtn${p}" disabled>N√§sta spelare</button>
      <p>Slag kvar: <span id="rollsLeft${p}">3</span></p>
      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle">
          <thead>
            <tr>
              <th class="row-label">Ruta</th>
              <th class="column-label">‚Üì</th>
              <th class="column-label">L</th>
              <th class="column-label">‚Üë</th>
              <th class="column-label">1</th>
            </tr>
          </thead>
          <tbody id="yanBody${p}"></tbody>
        </table>
      </div>
      <div class="log" id="log${p}"><strong>Historik:</strong><ul></ul></div>
    `;
    gameArea.appendChild(section);

    const tableBody = document.getElementById(`yanBody${p}`);
    rows.forEach(row => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${row.label}</td>`;
      for (let c = 1; c <= 4; c++) {
        const id = `p${p}_c${c}_${row.key}`;
        const input = document.createElement('input');
        input.type = 'number';
        input.id = id;
        input.className = row.readonly ? 'readonly form-control' : 'form-control';
        input.readOnly = !!row.readonly;
        input.oninput = () => calculateSums(p);
        const td = document.createElement('td');
        td.appendChild(input);
        tr.appendChild(td);
      }
      tableBody.appendChild(tr);
    });

    playerData.push({
      rollCount: 0,
      dice: [0, 0, 0, 0, 0],
      selected: [false, false, false, false, false]
    });
  }
  updatePlayerTurn();
}

function calculateSums(p) {
  let grandTotal = 0;
  let filled = true;

  for (let c = 1; c <= 4; c++) {
    let upperSum = 0;
    let totalSum = 0;

    for (let i = 1; i <= 6; i++) {
      const val = parseInt(document.getElementById(`p${p}_c${c}_r${i}`).value) || 0;
      upperSum += val;
      totalSum += val;
    }

    document.getElementById(`p${p}_c${c}_sum16`).value = upperSum;
    const bonus = upperSum >= 70 ? 70 : upperSum >= 60 ? 60 : 0;
    document.getElementById(`p${p}_c${c}_bonus`).value = bonus;
    totalSum += bonus;

    ['min','max','pair2','full','straight','four','yan'].forEach(key => {
      const val = parseInt(document.getElementById(`p${p}_c${c}_${key}`).value);
      if (!isNaN(val)) totalSum += val;
      else filled = false;
    });

    document.getElementById(`p${p}_c${c}_sumcol`).value = totalSum;

    const multiplier = c === 1 ? 2 : c === 2 ? 1 : c === 3 ? 3 : 4;
    const colTotal = totalSum * multiplier;
    document.getElementById(`p${p}_c${c}_total`).value = colTotal;
    grandTotal += colTotal;
  }

  const output = document.getElementById(`playerSection${p}`);
  const totalDisplayId = `totalDisplay${p}`;
  let display = document.getElementById(totalDisplayId);
  if (!display) {
    display = document.createElement('div');
    display.id = totalDisplayId;
    display.className = 'mt-2 fw-bold';
    output.appendChild(display);
  }
  display.innerText = filled ? `üèÅ Slutpo√§ng: ${grandTotal} po√§ng` : '';

  showWinner();
}

function showWinner() {
  const totals = [];
  const names = [];
  let allDone = true;

  for (let p = 0; p < playerData.length; p++) {
    let filled = true;
    let total = 0;
    for (let c = 1; c <= 4; c++) {
      const val = parseInt(document.getElementById(`p${p}_c${c}_total`).value);
      if (!isNaN(val)) total += val;
      else filled = false;
    }
    if (!filled) allDone = false;
    totals.push(total);
    names.push(document.getElementById(`playerName${p}`).value || `Spelare ${p+1}`);
  }

  if (!allDone) return;

  let highest = Math.max(...totals);
  let winnerIndex = totals.indexOf(highest);
  let winnerName = names[winnerIndex];

  if (!document.getElementById('winnerAnnounce')) {
    const result = document.createElement('div');
    result.className = 'alert alert-success mt-4';
    result.id = 'winnerAnnounce';
    result.innerText = `üèÜ ${winnerName} vinner med ${highest} po√§ng!`;
    document.querySelector('.container').appendChild(result);
  }
}
</script>
</body>
</html>
